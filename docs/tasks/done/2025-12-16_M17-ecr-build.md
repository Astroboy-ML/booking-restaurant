---
id: "2025-12-16_M17-ecr-build"
title: "M17 Build & push images to ECR"
type: feature
area: devops
agents_required: [devops]
depends_on: ["2025-12-16_M15-terraform-bootstrap"]
validated_by: "marti"
validated_at: "2025-12-18"
---

## Contexte
Les images Docker de l'API (et, si retenu, du front) doivent etre construites et poussees vers ECR pour preparer le deploiement sur EKS.

## Objectif
Fournir une chaine reproductible (Makefile + CI GitHub Actions) pour builder et publier les images vers un depot ECR authentifie via OIDC/assume role.

## Hors scope
- Creation du depot ECR (geree par Terraform dans d'autres tickets).
- Configuration d'images pour des services autres que API/web.
- Publication vers un registre autre qu'ECR.

## Scope technique
- Workflow GitHub Actions (login ECR via OIDC/assume role) pour build & push.
- Cibles Makefile pour build/push localement avec tags (commit SHA, eventuellement `latest`).
- Documentation des prerequis AWS (compte/region/role) et des variables attendues.

## Contraintes
- Aucun secret AWS en clair dans les workflows/scripts ; preferer OIDC/assume role ou secrets GitHub chiffrees.
- Taggage incluant au moins le commit SHA ; builds reproductibles (Dockerfile existant dans `apps/api`, `apps/web`).
- Scripts utilisables en local et en CI avec les memes variables (ACCOUNT_ID, REGION, REPO_NAME, IMAGE_TAG).

## Deliverables
- Workflow GitHub Actions pour build & push vers ECR (API obligatoire, web optionnel) avec login securise.
- Cibles Makefile/shell pour build/push manuel avec exemples de tags.
- Documentation d'usage (variables AWS, commandes locales et CI).

## Criteres d'acceptation
- [x] Un job CI permet de builder et pousser l'image API vers un depot ECR configure, en utilisant OIDC/assume role (pas de cles statiques).
- [x] Les tags incluent le SHA du commit (ex: `api:<sha>`), avec eventuellement un alias `latest` documente.
- [x] La documentation decrit les variables/permissions requises et la commande pour tester localement (login + push) sans secret en clair.

## Comment tester
1) Preparer les variables : `AWS_REGION=<region>`, `AWS_ACCOUNT_ID=<account>`, `ECR_REGISTRY=<account>.dkr.ecr.<region>.amazonaws.com`, `ECR_REPO_API=<repo>`, `IMAGE_TAG=$(git rev-parse --short HEAD)`.
2) Login ECR (local) : `make ecr-login AWS_REGION=$AWS_REGION ECR_REGISTRY=$ECR_REGISTRY`.
3) Construire/tagger/pousser l'image API : `make docker-build-api IMAGE_TAG=$IMAGE_TAG ECR_REGISTRY=$ECR_REGISTRY ECR_REPO_API=$ECR_REPO_API` puis `make docker-push-api ... PUBLISH_LATEST=true` si voulu.
4) Web optionnel : `ECR_REPO_WEB=<repo-web>` puis `make docker-build-web` et `make docker-push-web`.
5) Workflow CI : sur PR build seulement, sur `master` build+push avec OIDC (role `AWS_ROLE_TO_ASSUME`). Sans auth ECR le push doit echouer.

## Plan
1) Ajouter le workflow GitHub Actions avec login ECR via OIDC/assume role et etapes de build/push (API obligatoire, web optionnel).
2) Creer/mettre a jour les cibles Makefile pour build/push localement avec tags explicites (SHA + alias latest optionnel).
3) Documenter les variables attendues, exemples de commandes et procedure de test local/CI.

## A controler
- Resume : workflow `ecr-build.yml` (PR build-only, master build+push via OIDC), Makefile cibles build/tag/push ECR (API obligatoire, web optionnel), doc DEV mise a jour (variables, commandes locales/CI, troubleshooting).
- Fichiers modifies : `.github/workflows/ecr-build.yml`, `Makefile`, `docs/DEV.md`, `docs/tasks/in-progress/2025-12-16_M17-ecr-build.md`.
- Commandes executees : aucune (modifs declaratives); verifier `make docker-build-api ...` avec variables, et `act -j build-and-push` optionnel en simulant les vars.
- Checklist AC : tags avec SHA et alias latest (master uniquement), auth OIDC/assume role sans secrets statiques, doc des variables/prerequis et commandes locales coherentes Makefile/CI.
- Risques/rollback : echec push si role/vars AWS absents (comportement attendu) ; rollback par `git checkout -- Makefile docs/DEV.md .github/workflows/ecr-build.yml` et remettre le ticket en todo si besoin.
