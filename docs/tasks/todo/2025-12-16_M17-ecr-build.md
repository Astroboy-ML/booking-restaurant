---
id: "2025-12-16_M17-ecr-build"
title: "M17 Build & push images to ECR"
type: feature
area: devops
agents_required: [devops]
depends_on: ["2025-12-16_M15-terraform-bootstrap"]
validated_by:
validated_at:
---

## Contexte
Les images Docker de l’API (et possiblement du front) doivent être construites et poussées vers ECR pour préparer le déploiement sur EKS.

## Objectif
Fournir une chaîne reproductible (Makefile + CI GitHub Actions) pour builder et publier les images vers un dépôt ECR authentifié via OIDC/assume role.

## Hors scope
- Création du dépôt ECR (gérée par Terraform dans d’autres tickets).
- Configuration d’images pour des services autres que API/web.
- Publication vers un registre autre qu’ECR.

## Scope technique
- Workflow GitHub Actions (login ECR via OIDC/assume role) pour build & push.
- Cibles Makefile ou scripts pour build/push localement avec tags (commit SHA, éventuellement `latest`).
- Documentation des prérequis AWS (compte/region/role) et des variables attendues.

## Contraintes
- Aucun secret AWS en clair dans les workflows/scripts ; préférer OIDC/assume role ou secrets GitHub chiffrés.
- Taggage incluant au moins le commit SHA ; builds reproductibles (Dockerfile existant dans `apps/api`, `apps/web`).
- Scripts utilisables en local et en CI avec les mêmes variables (ACCOUNT_ID, REGION, REPO_NAME, IMAGE_TAG).

## Deliverables
- Workflow GitHub Actions pour build & push vers ECR (API et, si retenu, web) avec login sécurisé.
- Cibles Makefile/shell pour build/push manuel avec exemples de tags.
- Documentation d’usage (variables AWS, commandes locales et CI).

## Critères d’acceptation
- [ ] Un job CI permet de builder et pousser l’image API vers un dépôt ECR configuré, en utilisant OIDC/assume role (pas de clés statiques).
- [ ] Les tags incluent le SHA du commit (ex: `api:<sha>`), avec éventuellement un alias `latest` documenté.
- [ ] La documentation décrit les variables/permissions requises et la commande pour tester localement (login + push) sans secret en clair.

## Comment tester
1) Préparer les variables : `AWS_REGION=<region>`, `AWS_ACCOUNT_ID=<account>`, `ECR_REPO=<repo>`.
2) Login ECR (exemple local) : `aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com`.
3) Construire et tagger l’image API : `make docker-build api IMAGE_TAG=$GIT_SHA` (ou commande documentée) puis `docker tag <image> $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:$GIT_SHA`.
4) Pousser : `docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:$GIT_SHA`.
5) Vérifier le workflow CI en dry-run local si possible (`act -j <job>` avec variables simulées) ou via une branche de test.

## Plan
1) Ajouter le workflow GitHub Actions avec login ECR via OIDC/assume role et étapes de build/push.
2) Créer/mettre à jour les cibles Makefile pour build/push localement avec tags explicites.
3) Documenter les variables attendues, exemples de commandes et procédure de test local/CI.

## À contrôler
- Présence d’ARN/IDs sensibles dans le code : refuser si non nécessaires.
- Cohérence des tags entre Makefile et workflow CI.
- Vérifier que le workflow échoue si l’authentification ECR est absente ou invalide.
