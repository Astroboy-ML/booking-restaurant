---
id: "2025-12-16_M19-deploy-eks"
title: "M19 Deploiement application sur EKS"
type: feature
area: devops
agents_required: [devops]
depends_on: ["2025-12-16_M18-eks-skeleton", "2025-12-16_M17-ecr-build"]
validated_by:
validated_at:
---

## Contexte
Le cluster EKS et les images ECR sont prevus par les tickets precedents. Il faut fournir les manifests/Helm charts pour deployer l API (et, si faisable, le front) sur EKS avec configuration securisee.

## Objectif
Disposer d un deploiement Kubernetes pret pour EKS : Deployment/Service/Ingress/ConfigMap/Secret parametrables, utilisant les images ECR et avec healthchecks configures.

## Hors scope
- Creation du cluster ou du registre (M18/M17).
- Observabilite avancee (M20) ou gestion des secrets managee (M21).
- Migration base de donnees/DB bootstrap (si non existant sur le cluster).

## Scope technique
- Manifests Kubernetes ou chart Helm pour l API (web optionnel, si clair dans la doc) dans `k8s/` ou `charts/`.
- Configuration des images ECR (tag/digest), variables d environnement, secrets (references vers Secret/SSM/SealedSecrets, pas de clair).
- Ingress/Service/ConfigMap/Secret, readiness/liveness probes, autoscaling optionnel si simple.
- Documentation des commandes de deploiement (kubectl/helm) avec placeholders pour compte/region/ECR/hostnames.
- Overlay EKS : `k8s/overlays/eks-dev` (image ECR parametreable, host Ingress placeholder, secret API vide).

## Contraintes
- Aucun secret en clair ; secrets injectes via Kubernetes Secrets ou reference externe documentee.
- Healthchecks (readiness/liveness) actives ; ressources (requests/limits) par defaut raisonnables.
- Parametrage par environnement (dev/preprod/prod) possible via valeurs ou kustomize overlays.

## Deliverables
- Manifests ou chart Helm pour deployer l API (et mention explicite si le front est inclus ou exclu) sur EKS.
- Fichiers de configuration par environnement (overlays/values) avec variables ECR/hostnames.
- Documentation pas-a-pas pour deployer/mettre a jour/rollback (kubectl/helm).

## Criteres d acceptation
- [ ] `kubectl apply --dry-run=client -k <overlay_eks>` (ou `helm template --validate`) fonctionne et reference l image ECR via tag/digest.
- [ ] Les probes readiness/liveness sont presentes et utilisent les endpoints de sante de l API.
- [ ] Les secrets/configs sont injectes sans texte en clair dans Git (placeholders ou references a un store securise).
- [ ] La documentation decrit les commandes de deploiement et de rollback avec les variables a renseigner (namespace, host, image tag).

## Comment tester
1) Preparer un kubeconfig pointant vers le cluster de test (ou utiliser `--dry-run=client`).
2) `kubectl kustomize --load-restrictor=LoadRestrictionsNone k8s/overlays/eks-dev` puis `kubectl apply --dry-run=client -k k8s/overlays/eks-dev` et verifier l image referencee (ECR tag/digest).
3) `kubectl -n booking get deployment api -o yaml | findstr image:` pour confirmer le tag/digest ECR.
4) `kubectl -n booking describe deployment api` pour verifier les probes readiness/liveness.
5) Suivre la procedure de rollback documentee (ex: `kubectl rollout undo deployment/api`) sur un cluster de test ou en simulation.
6) Avant deploy, provisionner le Secret `api-secret` dans le namespace cible (ex: `kubectl -n booking create secret generic api-secret --from-literal=DATABASE_URL=postgresql://...`), car l overlay EKS ne fournit pas de valeur en clair.

## Plan
1) Structurer les manifests/Helm (Deployment, Service, Ingress, ConfigMap/Secret) avec variables ECR/hostnames/environnement.
2) Ajouter les probes et ressources par defaut ; prevoir des overlays/values par environnement.
3) Documenter les commandes kubectl/helm pour deployer, verifier et rollback, en precisant les variables a renseigner.

## A controler
- S assurer que le front est explicitement inclus ou exclu dans la doc pour eviter l ambiguite.
- Verifier la compatibilite avec l Ingress (hostname/cert) et le namespace attendu.
- Controler que les secrets ne sont pas commites et que les instructions de deploiement mentionnent leur provisionnement.
- Valider que l overlay `k8s/overlays/eks-dev` remplace l image par l ECR cible et laisse le Secret vide (a creer hors Git) avant un apply reel.
